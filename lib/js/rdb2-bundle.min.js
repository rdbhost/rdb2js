!function(a,b){function i(a){return function(b,c){for(var d=f(b),e=a>0?0:d-1;e>=0&&e<d;e+=a)if(c(b[e],e,b))return e;return-1}}a._={};var c={}.toString,d=_.property=function(a){return function(b){return null==b?void 0:b[a]}};_.filter=_.select=function(a,b,c){var d=[];return _.each(a,function(a,c,e){b(a,c,e)&&d.push(a)}),d};var e=Math.pow(2,53)-1,f=d("length"),g=function(a){var b=f(a);return"number"==typeof b&&b>=0&&b<=e};_.isArray=Array.isArray||function(a){return"[object Array]"===c.call(a)},_.isObject=function(a){var b=typeof a;return"function"===b||"object"===b&&!!a},_.isNumber=function(a){return"[object Number]"===c.call(a)},_.each=_.forEach=function(a,b){var c,d;if(g(a))for(c=0,d=a.length;c<d;c++)b(a[c],c,a);else{var e=_.keys(a);for(c=0,d=e.length;c<d;c++)b(a[e[c]],e[c],a)}return a};var h=function(a,b){return function(c){var d=arguments.length;if(b&&(c=Object(c)),d<2||null==c)return c;for(var e=1;e<d;e++)for(var f=arguments[e],g=a(f),h=g.length,i=0;i<h;i++){var j=g[i];b&&void 0!==c[j]||(c[j]=f[j])}return c}};_.allKeys=function(a){if(!_.isObject(a))return[];var b=[];for(var c in a)b.push(c);return b},_.extend=h(_.allKeys),_.findIndex=i(1),_.findLastIndex=i(-1)}(window),function(a){function b(){var b=a;return"Promise"in b&&"resolve"in b.Promise&&"reject"in b.Promise&&"all"in b.Promise&&"race"in b.Promise&&function(){var a;return new b.Promise(function(b){a=b}),"function"==typeof a}()}function c(){return"fetch"in a}a.Rdbhost=_.extend(a.Rdbhost||{},{featuredetects:{hasPromises:b,hasFetch:c}})}(window),function(a,b){"function"==typeof define&&define.amd?define([],b):"undefined"!=typeof module&&module.exports?module.exports=b():a.ReconnectingWebSocket=b()}(this,function(){function a(b,c,d){function l(a,b){var c;try{c=new CustomEvent(a,{detail:b,bubbles:!1,cancelable:!1})}catch(d){c=document.createEvent("CustomEvent"),c.initCustomEvent(a,!1,!1,b)}return c}var e={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"};d||(d={});for(var f in e)"undefined"!=typeof d[f]?this[f]=d[f]:this[f]=e[f];this.url=b,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var h,g=this,i=!1,j=!1,k=document.createElement("div");k.addEventListener("open",function(a){g.onopen(a)}),k.addEventListener("close",function(a){g.onclose(a)}),k.addEventListener("connecting",function(a){g.onconnecting(a)}),k.addEventListener("message",function(a){g.onmessage(a)}),k.addEventListener("error",function(a){g.onerror(a)}),this.addEventListener=k.addEventListener.bind(k),this.removeEventListener=k.removeEventListener.bind(k),this.dispatchEvent=k.dispatchEvent.bind(k),this.open=function(b){if(h=new WebSocket(g.url,c||[]),h.binaryType=this.binaryType,b){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else k.dispatchEvent(l("connecting",{})),this.reconnectAttempts=0;(g.debug||a.debugAll)&&console.log("ReconnectingWebSocket","attempt-connect",g.url);var d=h,e=setTimeout(function(){(g.debug||a.debugAll)&&console.log("ReconnectingWebSocket","connection-timeout",g.url),j=!0,d.close(),j=!1},g.timeoutInterval);h.onopen=function(c){clearTimeout(e),(g.debug||a.debugAll)&&console.log("ReconnectingWebSocket","onopen",g.url),g.protocol=h.protocol,g.readyState=WebSocket.OPEN,g.reconnectAttempts=0;var d=l("open",c);d.isReconnect=b,b=!1,k.dispatchEvent(d)},h.onclose=function(c){if(clearTimeout(e),h=null,i)g.readyState=WebSocket.CLOSED,k.dispatchEvent(l("close",c));else{g.readyState=WebSocket.CONNECTING;var d=l("connecting",c);d.code=c.code,d.reason=c.reason,d.wasClean=c.wasClean,k.dispatchEvent(d),b||j||((g.debug||a.debugAll)&&console.log("ReconnectingWebSocket","onclose",g.url),k.dispatchEvent(l("close",c)));var e=g.reconnectInterval*Math.pow(g.reconnectDecay,g.reconnectAttempts);setTimeout(function(){g.reconnectAttempts++,g.open(!0)},e>g.maxReconnectInterval?g.maxReconnectInterval:e)}},h.onmessage=function(b){(g.debug||a.debugAll)&&console.log("ReconnectingWebSocket","onmessage",g.url,b.data);var c=l("message",b);c.data=b.data,k.dispatchEvent(c)},h.onerror=function(b){(g.debug||a.debugAll)&&console.log("ReconnectingWebSocket","onerror",g.url,b),k.dispatchEvent(l("error",b))}},1==this.automaticOpen&&this.open(!1),this.send=function(b){if(h)return(g.debug||a.debugAll)&&console.log("ReconnectingWebSocket","send",g.url,b),h.send(b);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(a,b){"undefined"==typeof a&&(a=1e3),i=!0,h&&h.close(a,b)},this.refresh=function(){h&&h.close()}}if("WebSocket"in window)return a.prototype.onopen=function(a){},a.prototype.onclose=function(a){},a.prototype.onconnecting=function(a){},a.prototype.onmessage=function(a){},a.prototype.onerror=function(a){},a.debugAll=!1,a.CONNECTING=WebSocket.CONNECTING,a.OPEN=WebSocket.OPEN,a.CLOSING=WebSocket.CLOSING,a.CLOSED=WebSocket.CLOSED,a}),function(a){function b(){}b.prototype={on:function(a,b,c){var d=this.e||(this.e={});return(d[a]||(d[a]=[])).push({fn:b,ctx:c}),this},once:function(a,b,c){function e(){d.off(a,e),b.apply(c,arguments)}var d=this;return e._=b,this.on(a,e,c)},emit:function(a){var b=[].slice.call(arguments,1),c=((this.e||(this.e={}))[a]||[]).slice(),d=0,e=c.length;for(d;d<e;d++)c[d].fn.apply(c[d].ctx,b);return this},off:function(a,b){var c=this.e||(this.e={}),d=c[a],e=[];if(d&&b)for(var f=0,g=d.length;f<g;f++)d[f].fn!==b&&d[f].fn._!==b&&e.push(d[f]);return e.length?c[a]=e:delete c[a],this}},a.TinyEmitter=b}(window),function(a,b){"use strict";function o(){var a=sessionStorage.getItem("RDBHOST_CREDENTIALS_CACHE");return a?JSON.parse(a):{}}function p(a){var b=JSON.stringify(a);sessionStorage.setItem("RDBHOST_CREDENTIALS_CACHE",b)}function s(){return new Promise(function(a,b){var c=document.getElementById("RDBHOST-SQL-INLINE-ID");if(!c)return b(new Error("no inline sql found"));try{var d=c.textContent,e=JSON.parse(d)}catch(a){return console.log("handle_inline_sql error "+a.message),b(a)}if("OK"==e.status[1])return a(e);if("rdb10"===e.error[0]){var f=c.getAttribute("data-sql"),g=c.getAttribute("data-role");if("p"===g.substr(0,1)){var h=Rdbhost.preauth().query(f).go();h.then(function(b){a(b)}).catch(function(a){b(a)})}}else b(new Error(e.error.join(" ")))})}function t(a){Rdbhost.loader=k=function(b,c){a.script(b).wait(function(){c()})}}function u(a,b,c){var d=a.querySelector(b);d&&(~b.indexOf("span.")?d.textContent=c||"":d.value=c||"")}function v(a,b){var c=b.error,d=b.notice,e=b.sql,f=b.email,g=b.role,h=u.bind(null,a);h("span.error",c||""),h("span.notice",d||""),h("span.sql",e||""),h("input[name='password']",""),h("input[name='role']",g||""),h("input[name='email']",f||"")}function w(a,b){var c,d=u.bind(null,a),e=(c=a.querySelector("input[name='email']"))?c.value:"",f=(c=a.querySelector("input[name='role']"))?c.value:"",g=(c=a.querySelector("input[name='password']"))?c.value:"";if(e.length||f.length){if(g.length){var h=o();return e&&(h.email=e),f&&(h.role=f),p(h),b([e||f,g]),!0}return d("span.error","provide a password"),!1}return d("span.error","provide an email address"),!1}function x(a,b){return b(),!0}function y(a,b,c,d){var e=o(),f=_.extend({},d,{email:e.email,role:e.role});return z(a,b,c,f)}function z(a,b,c,d){function m(a){return!!i.contains(a.target)||(a.stopImmediatePropagation(),a.stopPropagation(),a.preventDefault(),!1)}d.error,d.sql,d.notice;if(j)return new Promise(function(f,g){e.once(r.formcleared,function(){f(z(a,b,c,d))})});var i=document.createElement("div");i.innerHTML=b;var k=i.firstElementChild.attributes.id.value,l=i.getElementsByTagName("style")[0];if(l.parentNode.removeChild(l),document.getElementById(k))throw new Error("Element ~i in dom already".replace("~i",k));return document.body.appendChild(i),document.head.appendChild(l),j=!0,e.emit(r.formdisplayed,[d.notice]),document.body.addEventListener("click",m,!0),new Promise(function(b,f){function h(c){c.stopPropagation(),c.preventDefault(),a(g,b)&&(document.body.removeChild(i),document.head.removeChild(l),document.body.removeEventListener("click",m,!0),j=!1,e.emit(r.formcleared,d.notice))}function n(a){a.stopPropagation(),a.preventDefault(),document.body.removeChild(i),document.head.removeChild(l),document.body.removeEventListener("click",m,!0),j=!1,e.emit(r.formcleared,d.notice),f(new Error("authorization dialog cancelled"))}var g=document.getElementById(k);c(g,d),g.querySelector("form").addEventListener("submit",h),g.querySelector(".cancel").addEventListener("click",n)})}function A(a,b){var c="000000000"+b;return a.substr(0,1).toLowerCase()+c.substr(c.length-10,10)}function B(a,b){function d(a){delete c[a],delete c[a+"_to"]}var c=X.authorization_cache;a+"_to"in c&&d(a);var e=setTimeout(function(){d(a)},27e5);b?(c[a]=b,c[a+"_to"]=e):d(a)}function C(a,b,c){var d=b&&_.isNumber(b);l=d?a:"www.rdbhost.com",m=d?b:a,n=(d?c:b)||"https://"+l+"/vendor/rdbhost/"+Rdbhost.version+"/lib/partials/"}function D(a){if(!m)throw new Error("account not set with connect method");if(f[a])throw new Error("connection already established for "+a);var b=A(a,m),c=!1;return f[a]=new ReconnectingWebSocket("wss://"+l+"/wsdb/"+b,null,{debug:d}),f[a].onopen=function(){c=!0,e.emit(r.connectionmade,a,m),e.emit(r.connectionmade+":"+a,a,m)},f[a].onclose=function(){e.emit(r.connectionclosed,a,m),e.emit(r.connectionclosed+":"+a,a,m)},f[a].onerror=function(){c?(e.emit(r.connectionerror,a,m),e.emit(r.connectionerror+":"+a,a,m)):e.emit(r.connectionopenfail,a,m)},f[a].onmessage=function(b){F(a,b.data)},f[a]}function E(a,b){for(var c in f)f.hasOwnProperty(c)&&(f[c].close(a,b),delete f[c])}function F(a,b){var g,i,j,c=JSON.parse(b),d=c["request-id"],f=h[d];if(d&&a!==d.substr(0,a.length))throw new Error("inconsistency between role ~r and reqId ~i".replace("~r",a).replace("~i",d));if(f)g=f[0],i=f[1],j=f[2],"error"===c.status[0]?(G(c.error),i(new Error("~1 ~2".replace("~1",c.error[0]).replace("~2",c.error[1])))):(_.each(j.result_hooks,function(a){a(c)}),g(Promise.resolve(c))),delete h[d];else if(d)console.log("Bad message request-id "+d);else if("notify"===c.status[0]){var k=c.payload,l=c.channel;"rdbhost_ftp_channel"===l.substr(0,19)?(e.emit(r.reloadrequest,l,k),e.emit(r.reloadrequest+":"+l,l,k)):(e.emit(r.notifyreceived,l,k),e.emit(r.notifyreceived+":"+l,l,k))}else"keep-alive"===c.status[0]&&console.log("keep-alive received")}function G(a){var b=a[0],c=a[1];e.emit(r.databaseerror,b,c),e.emit(r.databaseerror+":"+b,b,c),e.emit(r.databaseerror+":"+b.substr(0,2),b,c)}function H(a){var b=a[0],c=a[1];e.emit(r.databaseusererror,b,c),e.emit(r.databaseusererror+":"+b,b,c),e.emit(r.databaseusererror+":"+b.substr(0,2),b,c)}function I(a){if(!a.result_sets&&a.records){var b=a.records;a.result_sets=[b],delete a.records}}function J(a){var b=a.result_sets;if(b.length<2)throw new Error("invalid result set collection provided to strip_listen");b.splice(0,1),b.splice(b.length-2,2)}function K(a,b,c,d){var e=T(a);return e.then(function(a){return z(b,a,c,d)})}function L(a,b,c,d){var e=this,f=T(a+"_auth");return f.then(function(a){return y(w,a,v,{error:b,sql:c,notice:d})}).catch(function(a){throw a}).then(function(b){var f=b[0],g=b[1],h="auth"===a?$(m,a,g):Z(m,f,g);return h.catch(function(b){if("bad input. "===b.message.substr(0,11))return L.call(e,a,"fix input",c,d);if("bad email/p"===b.message.substr(0,11))return L.call(e,a,"bad email/pass combo",c,d);throw b})})}function P(){var a=_.findIndex(this.request_hooks,function(a){return"listen"===a.label});if(a>=0&&this.repeatCt&&this.repeatCt>1)throw new Error("listen and repeat cannot be used on same request");var b=this;_.each(this.request_hooks,function(a){a(b)})}function Q(){P.call(this);var a=this.formData;a.append("q",this.qPlus||this.q),delete this.qPlus,this.hasOwnProperty("repeatCt")&&a.append("repeat",this.repeatCt),this.hasOwnProperty("mode")&&a.append("mode",this.mode),"super"===this.role&&this.authorization_cache.super&&a.append("authcode",this.authorization_cache.super),"preauth"===this.role&&this.authorization_cache.preauth&&a.append("super-authcode",this.authorization_cache.preauth),"auth"===this.role&&this.authorization_cache.preauth&&(a.append("super-authcode",this.authorization_cache.preauth),a.append("authcode",this.authorization_cache.auth)),a.append("format","json-easy");var b=A(this.role,m),c="https://"+l+"/db/"+b;return[c,a]}function R(){P.call(this);var a={q:this.qPlus||this.q,args:this.args,namedParams:this.namedParams,"request-id":this.reqId};return delete this.qPlus,this.hasOwnProperty("repeatCt")&&(a.repeat=this.repeatCt),this.hasOwnProperty("mode")&&(a.mode=this.mode),"super"===this.role?a.authcode=this.authorization_cache.super:"preauth"===this.role?(a["super-authcode"]=this.authorization_cache.preauth,a.authcode="-"):"auth"===this.role&&(a["super-authcode"]=this.authorization_cache.preauth,a.authcode=this.authorization_cache.auth),JSON.stringify(a)}function S(){return"super"===this.role?!!this.authorization_cache.super:"preauth"===this.role?!!this.authorization_cache.preauth:"auth"===this.role&&!(!this.authorization_cache.preauth||!this.authorization_cache.auth)}function T(a){if(a in i)return Promise.resolve(i[a]);var b=n+a+".tpl.html",c=fetch(b);return c.then(function(c){if(!c.ok)throw new Error("page ~p not found.".replace("~p",b));var d=c.text();return d.then(function(b){return i[a]=b,i[a]})},function(a){throw a})}function U(a){var b=this;return new Promise(function(c,d){var e=a.call(b),f=e[0],g=e[1],h=fetch(f,{method:"post",body:g});return h.then(function(a){if(a.ok){var e=a.json();e.then(function(a){"error"===a.status[0]?(G(a.error),d(new Error("~1 ~2".replace("~1",a.error[0]).replace("~2",a.error[1])))):(_.each(b.result_hooks,function(b){b(a)}),c(a))})}else d(new Error("Status: "+a.status+" "+a.statusText))}).catch(function(a){d(a)})})}function V(a){function c(){var c=a.call(b);return new Promise(function(a,d){b.conn.send(c),h[b.reqId]=[a,d,b]})}var b=this;return f[b.role]&&f[b.role].readyState===q.OPEN?c():new Promise(function(a,d){e.once(r.connectionmade+":"+b.role,function(){a(c())})})}function W(a,b){function d(){if(!c.q)throw new Error("no query was provided");if(c.isDone)throw new Error("request has already been run. use clone to rerun it.");return c.formData?a.call(c):b.call(c)}var c=this;if(Rdbhost.paranoid_confirm&&S.call(this)){var e=T("any_confirm"),f=c.role.substr(0,1).toUpperCase()+c.role.substr(1);return e.then(function(a){return y(x,a,v,{error:"",sql:c.q,notice:f})}).catch(function(a){throw a}).then(function(){return d()})}return d()}function Y(a){_.extend(X,a)}function Z(a,b,c){var d="https://"+l+"/acct/login/0"+A("reader",a).substr(1),e=new FormData;e.append("arg:email",b),e.append("arg:password",c);var f=fetch(d,{method:"post",body:e});return f.then(function(a){return a.json().then(function(a){if(a.error)throw new Error(a.error[1]);for(var b in a.records.rows){var c=a.records.rows[b];if("s"===c.role.substr(0,1))return c}throw new Error("super not found in login records")})})}function $(a,b,c){var d=A("auth",a),e="https://"+l+"/acct/authlogin/0"+d.substr(1),f=new FormData;f.append("arg:role",d),f.append("arg:password",c);var g=fetch(e,{method:"post",body:f});return g.then(function(a){return a.json().then(function(a){if(a.error)throw new Error(a.error[1]);for(var b in a.records.rows){var c=a.records.rows[b];if("a"===c.role.substr(0,1))return c}throw new Error("auth not found in login records")})})}function ba(a,b,c,d){c=c||V,d=d||U;var e=Object.create(X),f=aa[a].bind(e,c,R),g=aa[a].bind(e,d,Q);return e.go=W.bind(e,g,f),b&&B(a,b),e.init(a)}function ca(c){if(f&&E(1e3,"reset"),f={},g=1,h={},i={},j=!1,k=function(a,b){throw new Error("no loader defined")},l=m=n=b,e=new TinyEmitter,a.Rdbhost=_.extend(a.Rdbhost,{on:e.on.bind(e),off:e.off.bind(e),once:e.once.bind(e)}),X.authorization_cache={},p({}),e.on(r.connectionopenfail,function(b){var c=fetch("//"+l+"/acct/corstest/"+m);c.then(function(b){b.json().then(function(b){"not-ok"===b.status?(console.log("This origin ("+a.location.origin+") is not a CORS-allowed origin for account "+m+"."),console.log("Allowed origins (obscured) are "+b.origins.join(", "))):console.log("Your connection failed, but your domain is CORS-allowed.")})})}),c)return c()}var e,f,g,h,i,j,k,l,m,n,c="latest",d=!0,q={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3},r={connectionmade:"connection-opened",connectionclosed:"connection-closed",connectionerror:"connection-error",connectionopenfail:"connection-open-failed",databaseerror:"database-error",databaseusererror:"database-user-error",notifyreceived:"notify-received",reloadrequest:"reload-request",formdisplayed:"form-displayed",formcleared:"form-cleared"};J.label="listen";var M=function(a,b){return L.call(this,"super","",a,b)},N=function(a,b){return L.call(this,"preauth","",a,b)},O=function(a,b){return L.call(this,"auth","",a,b)},X={authorization_cache:{},conn:b,init:function(a){if(["preauth","auth","reader","super"].indexOf(a)<0)throw new Error("invalid role "+a+" provided to init");return this.role=a,this.reqId=a+g++,this.isDone=!1,this.conn=f[a]||D(a),this.result_hooks=[I],this.request_hooks=[],this},proxy:function(a){return this.mode=a,this},query:function(a){return this.q=a,this},params:function(a,b){if(delete this.args,delete this.namedParams,!a&&!b)return this;if("object"!=typeof a)throw new Error("params must be object or array");if(b&&"object"!=typeof b)throw new Error("params must be object or array");if(this.formData)throw new Error("params and FormData cannot be used both in one request");if("number"==typeof a.length?this.args=a:this.namedParams=a,b)if("number"==typeof b.length){if("args"in this)throw new Error("two arrays were provided to params");this.args=b}else{if("namedParams"in this)throw new Error("two objects were provided to params");this.namedParams=b}return this},form_data:function(a){if(this.hasOwnProperty("args")&&this.args.length>0||this.hasOwnProperty("namedParams")&&Object.keys(this.namedParams).length>0)throw new Error("formData cannot be combined with params in same request.");return this.formData=a,this},listen:function(a){if(a.indexOf('"')>-1)throw new Error("channel name cannot include quotes");var b=function(b){var c=b.qPlus||b.q,d=['LISTEN "~1"'.replace("~1",a),c,"COMMIT; BEGIN;"];b.qPlus=d.join(";\n")};return b.label="listen",this.request_hooks.push(b),this.result_hooks.push(J),this},repeat:function(a){try{a=Number(a)}catch(a){throw new Error("provide number value to repeat method.")}return this.repeatCt=1,a>1&&(this.repeatCt=a),this},get_data:function(){return this.go().catch(function(a){var b=a.message.indexOf(" "),c=b>=0?b:a.message.length,d=a.message.substr(0,c),e=a.message.substr(c+1);throw H([d,e]),a})},clone:function(){var a=Rdbhost[this.role]();for(var b in this)!this.hasOwnProperty(b)||["reqId","conn","role","isDone","qPlus"].indexOf(b)>=0||"function"==typeof this[b]||(_.isArray(this[b])?a[b]=this[b].slice(0):_.isObject(this[b])?a[b]=_.extend({},this[b]):a[b]=this[b]);return a}},aa={};aa.super=function(a,b){var c=this,d=a.call(c,b);return d.catch(function(d){if("rdb12"===d.message.substr(0,5))return M.call(c,c.q,"Approve Super Query").then(function(d){return B("super",d.authcode),a.call(c,b)});throw d})},aa.reader=function(a,b){return a.call(this,b)},aa.preauth=function(a,b){var c=this,d=a.call(c,b);return d.catch(function(d){if("rdb10"===d.message.substr(0,5))return N.call(c,c.q,"Authorize Whitelisting of Query").then(function(d){return B("preauth",d.authcode),a.call(c,b)});throw d})},aa.auth=function(a,b){var c=this,d=a.call(c,b);return d.catch(function(d){if("rdb12"===d.message.substr(0,5))return O.call(c,c.q,"Approve Auth Query").then(function(d){return B("auth",d.authcode),a.call(c,b)}).catch(function(d){if("rdb10"===d.message.substr(0,5))return N.call(c,c.q,"Authorize Whitelisting of Query").then(function(d){return B("preauth",d.authcode),a.call(c,b)});throw d});throw d})},a.Rdbhost=_.extend(a.Rdbhost||{},{connect:C,disconnect:E,preauth:function(a,b){return ba("preauth",null,a,b)},auth:function(a,b,c){return ba("auth",a,b,c)},super:function(a,b,c){return ba("super",a,b,c)},reader:function(a,b){return ba("reader",null,a,b)},inline_sql:s,use_labjs_loader:t,loader:k,extend_request_prototype:Y,extendObject:function(a,b){var c=Object.create(a);c._parent=a;for(var d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return c},version:c,account_number:function(){return m},host:function(){return l},paranoid_confirm:!!1,show_form:K,reset_rdbhost:ca}),ca()}(window);